{% comment %}
  DreamGlow Interactive Quiz Section
  Cyrasoul - Premium Sleep & Beauty Supplement Quiz Funnel

  Installation:
  1. Copy this file to your theme's /sections/ folder
  2. Add {% section 'quiz-dreamglow' %} to any template or page
  3. Configure settings in Theme Editor
{% endcomment %}

<section
  class="dg-quiz"
  id="dreamglow-quiz-{{ section.id }}"
  data-section-id="{{ section.id }}"
  data-enable-email="{{ section.settings.enable_email }}"
  data-product-url="{% if section.settings.recommended_product %}{{ section.settings.recommended_product.url }}{% else %}/products/dreamglow{% endif %}"
  data-discount-code="{{ section.settings.discount_code }}"
  data-discount-percent="{{ section.settings.discount_percent }}"
>
  <!-- Progress Bar -->
  <div class="dg-quiz__progress" aria-hidden="true">
    <div class="dg-quiz__progress-bar" data-progress="0"></div>
    <span class="dg-quiz__progress-text">0 / 5</span>
  </div>

  <!-- INTRO SCREEN -->
  <div class="dg-quiz__screen dg-quiz__screen--intro active" data-screen="intro">
    <div class="dg-quiz__intro-content">
      <div class="dg-quiz__intro-icon">
        <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="40" cy="40" r="38" stroke="currentColor" stroke-width="2" opacity="0.3"/>
          <path class="dg-quiz__moon" d="M50 20C42 20 35 27 35 35C35 43 42 50 50 50C42 55 32 55 25 48C18 41 18 31 25 24C32 17 42 17 50 20Z" fill="currentColor"/>
          <circle class="dg-quiz__star dg-quiz__star--1" cx="58" cy="25" r="2" fill="currentColor"/>
          <circle class="dg-quiz__star dg-quiz__star--2" cx="65" cy="35" r="1.5" fill="currentColor"/>
          <circle class="dg-quiz__star dg-quiz__star--3" cx="55" cy="42" r="1" fill="currentColor"/>
        </svg>
      </div>
      <h2 class="dg-quiz__title">{{ section.settings.quiz_title | default: "Uyku & Cilt Analizi" }}</h2>
      <p class="dg-quiz__subtitle">{{ section.settings.quiz_subtitle | default: "3 dakikada kisisel raporunu al" }}</p>
      <button class="dg-quiz__btn dg-quiz__btn--primary" data-action="start">
        {{ section.settings.start_button | default: "Teste Basla" }}
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M7 5L12 10L7 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- QUESTION SCREENS -->
  {% assign questions = "sleep_duration,bedtime,skin_feel,stress_level,supplement_usage" | split: "," %}

  {% for q in questions %}
    {% assign q_index = forloop.index0 %}

    <div class="dg-quiz__screen dg-quiz__screen--question" data-screen="question" data-question="{{ q_index }}">
      <div class="dg-quiz__question-content">

        {% case q %}
          {% when "sleep_duration" %}
            <h3 class="dg-quiz__question-text">Dun gece kac saat uyudun?</h3>
            <div class="dg-quiz__answers">
              <button class="dg-quiz__answer" data-answer="0" data-score="1" data-color="#EF4444" data-insight="5 saat uyku ile cilt bariyerin %30 daha savunmasizdir.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/></svg>
                </span>
                <span class="dg-quiz__answer-text">5 saatten az</span>
              </button>
              <button class="dg-quiz__answer" data-answer="1" data-score="2" data-color="#F59E0B" data-insight="5-7 saat uyku, kolajen uretimini %20 azaltabilir.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/></svg>
                </span>
                <span class="dg-quiz__answer-text">5-7 saat</span>
              </button>
              <button class="dg-quiz__answer" data-answer="2" data-score="3" data-color="#D4AF37" data-insight="Harika! Optimal uyku suresi cilt yenilenmesi icin ideal.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/></svg>
                </span>
                <span class="dg-quiz__answer-text">7-9 saat</span>
              </button>
            </div>

          {% when "bedtime" %}
            <h3 class="dg-quiz__question-text">Yataga genellikle saat kacta girersin?</h3>
            <div class="dg-quiz__answers">
              <button class="dg-quiz__answer" data-answer="0" data-score="3" data-color="#D4AF37" data-insight="Mukemmel! HGH ve kolajen uretim zirvesini yakaliyorsun.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z" stroke="currentColor" stroke-width="2"/></svg>
                </span>
                <span class="dg-quiz__answer-text">22:00-23:00</span>
              </button>
              <button class="dg-quiz__answer" data-answer="1" data-score="2" data-color="#F59E0B" data-insight="Altin pencereyi kismen yakaliyorsun, daha erken yatmayi dene.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z" stroke="currentColor" stroke-width="2"/></svg>
                </span>
                <span class="dg-quiz__answer-text">23:00-01:00</span>
              </button>
              <button class="dg-quiz__answer" data-answer="2" data-score="1" data-color="#EF4444" data-insight="01:00'den sonra uyumak, buyume hormonu zirvesini kacirmak demektir.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z" stroke="currentColor" stroke-width="2"/></svg>
                </span>
                <span class="dg-quiz__answer-text">01:00 sonrasi</span>
              </button>
            </div>

          {% when "skin_feel" %}
            <h3 class="dg-quiz__question-text">Sabah cildin nasil hissettiriyor?</h3>
            <div class="dg-quiz__answers">
              <button class="dg-quiz__answer" data-answer="0" data-score="1" data-color="#EF4444" data-insight="Gece boyunca nem kaybi yasiyorsun. Hyaluronik Asit bunu onler.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M8 14s1.5 2 4 2 4-2 4-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="9" cy="9" r="1" fill="currentColor"/><circle cx="15" cy="9" r="1" fill="currentColor"/></svg>
                </span>
                <span class="dg-quiz__answer-text">Kuru ve gergin</span>
              </button>
              <button class="dg-quiz__answer" data-answer="1" data-score="2" data-color="#F59E0B" data-insight="Sislik, yetersiz lenf drenajina isaret. Melisa rahatlatici etki saglar.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M8 15s1.5 1 4 1 4-1 4-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="9" cy="10" r="1" fill="currentColor"/><circle cx="15" cy="10" r="1" fill="currentColor"/></svg>
                </span>
                <span class="dg-quiz__answer-text">Yorgun ve sis</span>
              </button>
              <button class="dg-quiz__answer" data-answer="2" data-score="3" data-color="#D4AF37" data-insight="Cildin iyi durumda! DreamGlow ile bu seviyeyi koruyabilirsin.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M8 13s1.5 3 4 3 4-3 4-3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="9" cy="9" r="1" fill="currentColor"/><circle cx="15" cy="9" r="1" fill="currentColor"/></svg>
                </span>
                <span class="dg-quiz__answer-text">Canli ve nemli</span>
              </button>
            </div>

          {% when "stress_level" %}
            <h3 class="dg-quiz__question-text">Gun icinde stres seviyeni nasil tanimlarsın?</h3>
            <div class="dg-quiz__answers">
              <button class="dg-quiz__answer" data-answer="0" data-score="1" data-color="#EF4444" data-insight="Yuksek kortizol kolajen parcalanmasini hizlandirir. Papatya rahatlama saglar.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                </span>
                <span class="dg-quiz__answer-text">Cok yuksek</span>
              </button>
              <button class="dg-quiz__answer" data-answer="1" data-score="2" data-color="#F59E0B" data-insight="Orta stres yonetilebilir. Gece rutini ile uyku kalitesini artirabilirsin.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                </span>
                <span class="dg-quiz__answer-text">Orta duzey</span>
              </button>
              <button class="dg-quiz__answer" data-answer="2" data-score="3" data-color="#D4AF37" data-insight="Stresini iyi yonetiyorsun! Bu cildin icin buyuk avantaj.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                </span>
                <span class="dg-quiz__answer-text">Dusuk/Kontrol altinda</span>
              </button>
            </div>

          {% when "supplement_usage" %}
            <h3 class="dg-quiz__question-text">Cilt veya uyku icin takviye kullaniyor musun?</h3>
            <div class="dg-quiz__answers">
              <button class="dg-quiz__answer" data-answer="0" data-score="1" data-color="#EF4444" data-insight="Takviyesiz, cilt ve uyku optimizasyonu zorlasir.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                </span>
                <span class="dg-quiz__answer-text">Hayir, hic kullanmiyorum</span>
              </button>
              <button class="dg-quiz__answer" data-answer="1" data-score="2" data-color="#F59E0B" data-insight="Duzensiz kullanim sonuc almayi geciktirir. Rutin onemli.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                </span>
                <span class="dg-quiz__answer-text">Bazen, duzensiz</span>
              </button>
              <button class="dg-quiz__answer" data-answer="2" data-score="3" data-color="#D4AF37" data-insight="Duzenli kullanim anahtardir. DreamGlow'u rutinine ekle.">
                <span class="dg-quiz__answer-icon">
                  <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M9 16l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </span>
                <span class="dg-quiz__answer-text">Evet, duzenli</span>
              </button>
            </div>
        {% endcase %}
      </div>

      <!-- FEEDBACK CARD (initially hidden) -->
      <div class="dg-quiz__feedback" data-feedback="{{ q_index }}">
        <div class="dg-quiz__feedback-card">
          <div class="dg-quiz__visualization" data-viz-type="{{ q }}">
            <!-- SVG will be injected here by JS based on answer -->
          </div>
          <p class="dg-quiz__insight"></p>
          <button class="dg-quiz__btn dg-quiz__btn--secondary" data-action="next">
            {% if forloop.last %}
              Sonuclari Gor
            {% else %}
              Sonraki Soru
            {% endif %}
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M7 5L12 10L7 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  {% endfor %}

  <!-- EMAIL CAPTURE SCREEN -->
  <div class="dg-quiz__screen dg-quiz__screen--email" data-screen="email">
    <div class="dg-quiz__email-content">
      <div class="dg-quiz__email-icon">
        <svg viewBox="0 0 64 64" fill="none">
          <rect x="8" y="16" width="48" height="32" rx="4" stroke="currentColor" stroke-width="2"/>
          <path d="M8 20L32 36L56 20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <h3 class="dg-quiz__email-title">{{ section.settings.email_title | default: "Kisisel Raporun Hazir!" }}</h3>
      <p class="dg-quiz__email-subtitle">{{ section.settings.email_subtitle | default: "Tam analiz ve oneriler icin email adresini gir" }}</p>
      <form class="dg-quiz__email-form" data-action="submit-email">
        <div class="dg-quiz__input-group">
          <input
            type="email"
            class="dg-quiz__input"
            placeholder="email@ornek.com"
            required
            autocomplete="email"
          >
          <button type="submit" class="dg-quiz__btn dg-quiz__btn--primary">
            Raporumu Gor
          </button>
        </div>
      </form>
      <button class="dg-quiz__skip" data-action="skip-email">
        Raporumu email'siz gor
      </button>
    </div>
  </div>

  <!-- RESULTS SCREEN -->
  <div class="dg-quiz__screen dg-quiz__screen--results" data-screen="results">
    <div class="dg-quiz__results-content">
      <div class="dg-quiz__results-header">
        <h3 class="dg-quiz__results-title">Senin Uyku & Cilt Profilin</h3>
        <div class="dg-quiz__overall-score">
          <div class="dg-quiz__score-circle">
            <svg viewBox="0 0 100 100">
              <circle class="dg-quiz__score-bg" cx="50" cy="50" r="45"/>
              <circle class="dg-quiz__score-fill" cx="50" cy="50" r="45"/>
            </svg>
            <span class="dg-quiz__score-value">0</span>
          </div>
          <span class="dg-quiz__score-label">Genel Skor</span>
        </div>
      </div>

      <div class="dg-quiz__deficiency">
        <span class="dg-quiz__deficiency-label">Senin icin en kritik eksik:</span>
        <span class="dg-quiz__deficiency-value"></span>
      </div>

      <div class="dg-quiz__score-breakdown">
        <div class="dg-quiz__score-item" data-category="sleep">
          <span class="dg-quiz__score-item-label">Uyku Kalitesi</span>
          <div class="dg-quiz__score-item-bar">
            <div class="dg-quiz__score-item-fill"></div>
          </div>
        </div>
        <div class="dg-quiz__score-item" data-category="skin">
          <span class="dg-quiz__score-item-label">Cilt Sagligi</span>
          <div class="dg-quiz__score-item-bar">
            <div class="dg-quiz__score-item-fill"></div>
          </div>
        </div>
        <div class="dg-quiz__score-item" data-category="recovery">
          <span class="dg-quiz__score-item-label">Iyilesme Potansiyeli</span>
          <div class="dg-quiz__score-item-bar">
            <div class="dg-quiz__score-item-fill"></div>
          </div>
        </div>
      </div>

      <div class="dg-quiz__recommendation">
        <p class="dg-quiz__recommendation-text"></p>
      </div>

      <!-- Product Card -->
      <div class="dg-quiz__product">
        <div class="dg-quiz__product-image">
          {% if section.settings.recommended_product %}
            {{ section.settings.recommended_product.featured_image | image_url: width: 300 | image_tag: loading: 'lazy' }}
          {% else %}
            <div class="dg-quiz__product-placeholder">
              <svg viewBox="0 0 80 80" fill="none">
                <rect x="15" y="10" width="50" height="60" rx="8" stroke="currentColor" stroke-width="2"/>
                <circle cx="40" cy="35" r="12" stroke="currentColor" stroke-width="2"/>
                <path d="M40 28v14M33 35h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M25 55h30" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
          {% endif %}
        </div>
        <div class="dg-quiz__product-info">
          <h4 class="dg-quiz__product-name">
            {% if section.settings.recommended_product %}
              {{ section.settings.recommended_product.title }}
            {% else %}
              DreamGlow
            {% endif %}
          </h4>
          <p class="dg-quiz__product-benefits">Kolajen + Melisa + Papatya + Hyaluronik Asit</p>
          <div class="dg-quiz__product-price">
            {% if section.settings.recommended_product %}
              {{ section.settings.recommended_product.price | money }}
            {% else %}
              <span class="dg-quiz__price-original">₺599</span>
              <span class="dg-quiz__price-sale">₺509</span>
            {% endif %}
          </div>
        </div>
        <a href="{{ section.settings.recommended_product.url | default: '/products/dreamglow' }}{% if section.settings.discount_code != blank %}?discount={{ section.settings.discount_code }}{% endif %}" class="dg-quiz__btn dg-quiz__btn--cta">
          Gece Rutinini Baslar - %{{ section.settings.discount_percent | default: '15' }} Indirimli Al
        </a>
      </div>

      <button class="dg-quiz__restart" data-action="restart">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M2 8a6 6 0 1011.5-2.5M14 2v4h-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Testi Tekrarla
      </button>
    </div>
  </div>
</section>

<style>
  /* ============================================
     DreamGlow Quiz - CSS Styles
     ============================================ */

  /* CSS Custom Properties */
  #dreamglow-quiz-{{ section.id }} {
    --dg-bg-primary: #0A0F1C;
    --dg-bg-secondary: #111827;
    --dg-bg-card: #1F2937;
    --dg-bg-card-hover: #374151;
    --dg-gold: {{ section.settings.color_gold | default: '#D4AF37' }};
    --dg-gold-light: #F5DEB3;
    --dg-amber: {{ section.settings.color_amber | default: '#F59E0B' }};
    --dg-red: {{ section.settings.color_red | default: '#EF4444' }};
    --dg-text-primary: #F9FAFB;
    --dg-text-secondary: #9CA3AF;
    --dg-text-muted: #6B7280;
    --dg-border: #374151;

    --dg-font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --dg-font-size-xl: clamp(1.5rem, 4vw, 2rem);
    --dg-font-size-lg: clamp(1.125rem, 3vw, 1.5rem);
    --dg-font-size-base: 1rem;
    --dg-font-size-sm: 0.875rem;
    --dg-font-size-xs: 0.75rem;

    --dg-spacing-xs: 0.5rem;
    --dg-spacing-sm: 1rem;
    --dg-spacing-md: 1.5rem;
    --dg-spacing-lg: 2rem;
    --dg-spacing-xl: 3rem;

    --dg-radius-sm: 0.5rem;
    --dg-radius-md: 0.75rem;
    --dg-radius-lg: 1rem;
    --dg-radius-xl: 1.5rem;

    --dg-transition-fast: 150ms ease;
    --dg-transition-base: 300ms ease;
    --dg-transition-slow: 500ms ease-out;

    --dg-shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
    --dg-shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
    --dg-shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
    --dg-glow: 0 0 20px rgba(212, 175, 55, 0.3);
  }

  /* Base Styles */
  .dg-quiz {
    font-family: var(--dg-font-family) !important;
    background: var(--dg-bg-primary) !important;
    color: var(--dg-text-primary) !important;
    min-height: 100vh;
    min-height: 100dvh;
    position: relative;
    overflow: hidden;
  }

  .dg-quiz *,
  .dg-quiz *::before,
  .dg-quiz *::after {
    box-sizing: border-box;
  }

  /* Force text colors - Shopify override fix */
  #dreamglow-quiz-{{ section.id }} h2,
  #dreamglow-quiz-{{ section.id }} h3,
  #dreamglow-quiz-{{ section.id }} h4,
  #dreamglow-quiz-{{ section.id }} p,
  #dreamglow-quiz-{{ section.id }} span,
  #dreamglow-quiz-{{ section.id }} button,
  #dreamglow-quiz-{{ section.id }} a,
  #dreamglow-quiz-{{ section.id }} label,
  #dreamglow-quiz-{{ section.id }} input {
    color: inherit !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__title {
    background: linear-gradient(135deg, #F9FAFB, #F5DEB3) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__subtitle,
  #dreamglow-quiz-{{ section.id }} .dg-quiz__text-secondary {
    color: #9CA3AF !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__question-text {
    color: #F9FAFB !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__answer {
    color: #F9FAFB !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__answer-text {
    color: #F9FAFB !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__insight {
    color: #9CA3AF !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__email-title,
  #dreamglow-quiz-{{ section.id }} .dg-quiz__results-title {
    color: #F9FAFB !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__email-subtitle {
    color: #9CA3AF !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__score-value {
    color: #D4AF37 !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__score-label,
  #dreamglow-quiz-{{ section.id }} .dg-quiz__deficiency-label,
  #dreamglow-quiz-{{ section.id }} .dg-quiz__score-item-label {
    color: #9CA3AF !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__deficiency-value {
    color: #F59E0B !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__recommendation-text {
    color: #F9FAFB !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__product-name {
    color: #F9FAFB !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__product-benefits {
    color: #9CA3AF !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__price-original {
    color: #6B7280 !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__price-sale {
    color: #D4AF37 !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__btn--primary,
  #dreamglow-quiz-{{ section.id }} .dg-quiz__btn--cta {
    color: #0A0F1C !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__btn--secondary {
    color: #F9FAFB !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__skip,
  #dreamglow-quiz-{{ section.id }} .dg-quiz__restart {
    color: #6B7280 !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__skip:hover,
  #dreamglow-quiz-{{ section.id }} .dg-quiz__restart:hover {
    color: #9CA3AF !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__input {
    color: #F9FAFB !important;
    background: #1F2937 !important;
  }

  #dreamglow-quiz-{{ section.id }} .dg-quiz__input::placeholder {
    color: #6B7280 !important;
  }

  /* Progress Bar */
  .dg-quiz__progress {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--dg-bg-secondary);
    z-index: 100;
    display: flex;
    align-items: center;
  }

  .dg-quiz__progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--dg-gold), var(--dg-gold-light));
    width: 0%;
    transition: width var(--dg-transition-slow);
    box-shadow: var(--dg-glow);
  }

  .dg-quiz__progress-text {
    position: absolute;
    right: var(--dg-spacing-sm);
    top: 12px;
    font-size: var(--dg-font-size-xs);
    color: var(--dg-text-muted);
    opacity: 0;
    transition: opacity var(--dg-transition-base);
  }

  .dg-quiz[data-started="true"] .dg-quiz__progress-text {
    opacity: 1;
  }

  /* Screen Base */
  .dg-quiz__screen {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--dg-spacing-lg);
    padding-top: calc(var(--dg-spacing-lg) + 20px);
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px);
    transition: opacity var(--dg-transition-base), transform var(--dg-transition-base), visibility 0s var(--dg-transition-base);
  }

  .dg-quiz__screen.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    transition: opacity var(--dg-transition-base), transform var(--dg-transition-base), visibility 0s 0s;
  }

  /* Results screen - scrollable */
  .dg-quiz__screen--results {
    justify-content: flex-start !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    -webkit-overflow-scrolling: touch !important;
    padding-top: 40px !important;
    padding-bottom: 60px !important;
  }

  .dg-quiz__screen--results.active {
    display: flex !important;
  }

  /* Intro Screen */
  .dg-quiz__intro-content {
    text-align: center;
    max-width: 400px;
  }

  .dg-quiz__intro-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto var(--dg-spacing-lg);
    color: var(--dg-gold);
  }

  .dg-quiz__intro-icon svg {
    width: 100%;
    height: 100%;
  }

  .dg-quiz__moon {
    animation: moonGlow 3s ease-in-out infinite;
  }

  .dg-quiz__star {
    animation: twinkle 2s ease-in-out infinite;
  }

  .dg-quiz__star--2 { animation-delay: 0.5s; }
  .dg-quiz__star--3 { animation-delay: 1s; }

  @keyframes moonGlow {
    0%, 100% { opacity: 0.8; }
    50% { opacity: 1; }
  }

  @keyframes twinkle {
    0%, 100% { opacity: 0.5; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.2); }
  }

  .dg-quiz__title {
    font-size: var(--dg-font-size-xl);
    font-weight: 700;
    margin: 0 0 var(--dg-spacing-xs);
    background: linear-gradient(135deg, var(--dg-text-primary), var(--dg-gold-light));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .dg-quiz__subtitle {
    font-size: var(--dg-font-size-base);
    color: var(--dg-text-secondary);
    margin: 0 0 var(--dg-spacing-lg);
  }

  /* Buttons */
  .dg-quiz__btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--dg-spacing-xs);
    font-family: inherit;
    font-size: var(--dg-font-size-base);
    font-weight: 600;
    padding: var(--dg-spacing-sm) var(--dg-spacing-lg);
    border: none;
    border-radius: var(--dg-radius-lg);
    cursor: pointer;
    transition: all var(--dg-transition-fast);
    min-height: 48px;
    min-width: 48px;
    text-decoration: none;
  }

  .dg-quiz__btn--primary {
    background: linear-gradient(135deg, var(--dg-gold), #B8962E);
    color: var(--dg-bg-primary);
    box-shadow: var(--dg-shadow-sm), var(--dg-glow);
  }

  .dg-quiz__btn--primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--dg-shadow-md), 0 0 30px rgba(212, 175, 55, 0.4);
  }

  .dg-quiz__btn--primary:active {
    transform: translateY(0);
  }

  .dg-quiz__btn--secondary {
    background: var(--dg-bg-card);
    color: var(--dg-text-primary);
    border: 1px solid var(--dg-border);
  }

  .dg-quiz__btn--secondary:hover {
    background: var(--dg-bg-card-hover);
    border-color: var(--dg-gold);
  }

  .dg-quiz__btn--cta {
    width: 100%;
    background: linear-gradient(135deg, var(--dg-gold), #B8962E);
    color: var(--dg-bg-primary);
    font-size: var(--dg-font-size-sm);
    padding: var(--dg-spacing-md);
    box-shadow: var(--dg-shadow-md), var(--dg-glow);
  }

  .dg-quiz__btn--cta:hover {
    transform: scale(1.02);
    box-shadow: var(--dg-shadow-lg), 0 0 40px rgba(212, 175, 55, 0.5);
  }

  /* Question Screen */
  .dg-quiz__question-content {
    width: 100%;
    max-width: 500px;
  }

  .dg-quiz__question-text {
    font-size: var(--dg-font-size-lg);
    font-weight: 600;
    text-align: center;
    margin: 0 0 var(--dg-spacing-lg);
    line-height: 1.4;
  }

  .dg-quiz__answers {
    display: flex;
    flex-direction: column;
    gap: var(--dg-spacing-sm);
  }

  .dg-quiz__answer {
    display: flex;
    align-items: center;
    gap: var(--dg-spacing-sm);
    width: 100%;
    padding: var(--dg-spacing-md);
    background: var(--dg-bg-card);
    border: 2px solid var(--dg-border);
    border-radius: var(--dg-radius-md);
    color: var(--dg-text-primary);
    font-family: inherit;
    font-size: var(--dg-font-size-base);
    text-align: left;
    cursor: pointer;
    transition: all var(--dg-transition-fast);
    min-height: 64px;
  }

  .dg-quiz__answer:hover {
    background: var(--dg-bg-card-hover);
    border-color: var(--dg-gold);
    transform: translateX(4px);
  }

  .dg-quiz__answer:active {
    transform: translateX(2px) scale(0.99);
  }

  .dg-quiz__answer.selected {
    border-color: var(--dg-gold);
    background: rgba(212, 175, 55, 0.1);
  }

  .dg-quiz__answer-icon {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    color: var(--dg-text-secondary);
  }

  .dg-quiz__answer-icon svg {
    width: 100%;
    height: 100%;
  }

  .dg-quiz__answer:hover .dg-quiz__answer-icon,
  .dg-quiz__answer.selected .dg-quiz__answer-icon {
    color: var(--dg-gold);
  }

  .dg-quiz__answer-text {
    flex: 1;
    font-weight: 500;
  }

  /* Feedback Card */
  .dg-quiz__feedback {
    position: fixed;
    inset: 0;
    background: rgba(10, 15, 28, 0.9);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--dg-spacing-lg);
    opacity: 0;
    visibility: hidden;
    transition: opacity var(--dg-transition-base), visibility 0s var(--dg-transition-base);
    z-index: 50;
  }

  .dg-quiz__feedback.active {
    opacity: 1;
    visibility: visible;
    transition: opacity var(--dg-transition-base), visibility 0s 0s;
  }

  .dg-quiz__feedback-card {
    background: var(--dg-bg-secondary);
    border: 1px solid var(--dg-border);
    border-radius: var(--dg-radius-xl);
    padding: var(--dg-spacing-lg);
    max-width: 400px;
    width: 100%;
    text-align: center;
    transform: translateY(30px) scale(0.95);
    transition: transform var(--dg-transition-slow);
    box-shadow: var(--dg-shadow-lg);
  }

  .dg-quiz__feedback.active .dg-quiz__feedback-card {
    transform: translateY(0) scale(1);
  }

  .dg-quiz__visualization {
    width: 100%;
    height: 180px;
    margin-bottom: var(--dg-spacing-md);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .dg-quiz__visualization svg {
    max-width: 100%;
    max-height: 100%;
  }

  .dg-quiz__insight {
    font-size: var(--dg-font-size-sm);
    color: var(--dg-text-secondary);
    line-height: 1.6;
    margin: 0 0 var(--dg-spacing-lg);
  }

  /* Email Screen */
  .dg-quiz__email-content {
    text-align: center;
    max-width: 400px;
    width: 100%;
  }

  .dg-quiz__email-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto var(--dg-spacing-md);
    color: var(--dg-gold);
  }

  .dg-quiz__email-icon svg {
    width: 100%;
    height: 100%;
  }

  .dg-quiz__email-title {
    font-size: var(--dg-font-size-lg);
    font-weight: 600;
    margin: 0 0 var(--dg-spacing-xs);
  }

  .dg-quiz__email-subtitle {
    font-size: var(--dg-font-size-sm);
    color: var(--dg-text-secondary);
    margin: 0 0 var(--dg-spacing-lg);
  }

  .dg-quiz__email-form {
    margin-bottom: var(--dg-spacing-md);
  }

  .dg-quiz__input-group {
    display: flex;
    flex-direction: column;
    gap: var(--dg-spacing-sm);
  }

  .dg-quiz__input {
    width: 100%;
    padding: var(--dg-spacing-md);
    background: var(--dg-bg-card);
    border: 2px solid var(--dg-border);
    border-radius: var(--dg-radius-md);
    color: var(--dg-text-primary);
    font-family: inherit;
    font-size: var(--dg-font-size-base);
    transition: border-color var(--dg-transition-fast);
    min-height: 52px;
  }

  .dg-quiz__input::placeholder {
    color: var(--dg-text-muted);
  }

  .dg-quiz__input:focus {
    outline: none;
    border-color: var(--dg-gold);
  }

  .dg-quiz__skip {
    background: none;
    border: none;
    color: var(--dg-text-muted);
    font-family: inherit;
    font-size: var(--dg-font-size-sm);
    cursor: pointer;
    padding: var(--dg-spacing-xs);
    transition: color var(--dg-transition-fast);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .dg-quiz__skip:hover {
    color: var(--dg-text-secondary);
  }

  /* Results Screen */
  .dg-quiz__results-content {
    max-width: 450px;
    width: 100%;
    padding-bottom: 80px !important;
    flex-shrink: 0 !important;
  }

  .dg-quiz__results-header {
    text-align: center;
    margin-bottom: var(--dg-spacing-lg);
  }

  .dg-quiz__results-title {
    font-size: var(--dg-font-size-lg);
    font-weight: 600;
    margin: 0 0 var(--dg-spacing-md);
  }

  .dg-quiz__overall-score {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--dg-spacing-xs);
  }

  .dg-quiz__score-circle {
    position: relative;
    width: 100px;
    height: 100px;
  }

  .dg-quiz__score-circle svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
  }

  .dg-quiz__score-bg {
    fill: none;
    stroke: var(--dg-bg-card);
    stroke-width: 8;
  }

  .dg-quiz__score-fill {
    fill: none;
    stroke: var(--dg-gold);
    stroke-width: 8;
    stroke-linecap: round;
    stroke-dasharray: 283;
    stroke-dashoffset: 283;
    transition: stroke-dashoffset 1s ease-out;
  }

  .dg-quiz__score-value {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--dg-font-size-xl);
    font-weight: 700;
    color: var(--dg-gold);
  }

  .dg-quiz__score-label {
    font-size: var(--dg-font-size-sm);
    color: var(--dg-text-secondary);
  }

  .dg-quiz__deficiency {
    background: var(--dg-bg-card);
    border: 1px solid var(--dg-border);
    border-radius: var(--dg-radius-md);
    padding: var(--dg-spacing-md);
    margin-bottom: var(--dg-spacing-lg);
    text-align: center;
  }

  .dg-quiz__deficiency-label {
    display: block;
    font-size: var(--dg-font-size-sm);
    color: var(--dg-text-secondary);
    margin-bottom: var(--dg-spacing-xs);
  }

  .dg-quiz__deficiency-value {
    font-size: var(--dg-font-size-base);
    font-weight: 600;
    color: var(--dg-amber);
  }

  .dg-quiz__score-breakdown {
    display: flex;
    flex-direction: column;
    gap: var(--dg-spacing-sm);
    margin-bottom: var(--dg-spacing-lg);
  }

  .dg-quiz__score-item {
    display: flex;
    flex-direction: column;
    gap: var(--dg-spacing-xs);
  }

  .dg-quiz__score-item-label {
    font-size: var(--dg-font-size-sm);
    color: var(--dg-text-secondary);
  }

  .dg-quiz__score-item-bar {
    height: 8px !important;
    background: #1F2937 !important;
    border-radius: 4px !important;
    overflow: visible !important;
    position: relative !important;
  }

  .dg-quiz__score-item-fill {
    width: 100% !important;
    height: 8px !important;
    background: linear-gradient(90deg, #D4AF37, #F5DEB3) !important;
    border-radius: 4px !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    transform: scaleX(0) !important;
    transform-origin: left center !important;
  }

  .dg-quiz__recommendation {
    background: rgba(212, 175, 55, 0.1);
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: var(--dg-radius-md);
    padding: var(--dg-spacing-md);
    margin-bottom: var(--dg-spacing-lg);
  }

  .dg-quiz__recommendation-text {
    font-size: var(--dg-font-size-sm);
    color: var(--dg-text-primary);
    line-height: 1.6;
    margin: 0;
  }

  /* Product Card */
  .dg-quiz__product {
    background: var(--dg-bg-secondary);
    border: 1px solid var(--dg-border);
    border-radius: var(--dg-radius-lg);
    padding: var(--dg-spacing-md);
    margin-bottom: var(--dg-spacing-md);
  }

  .dg-quiz__product-image {
    width: 120px;
    height: 120px;
    margin: 0 auto var(--dg-spacing-md);
    border-radius: var(--dg-radius-md);
    overflow: hidden;
    background: var(--dg-bg-card);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .dg-quiz__product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .dg-quiz__product-placeholder {
    width: 80px;
    height: 80px;
    color: var(--dg-text-muted);
  }

  .dg-quiz__product-placeholder svg {
    width: 100%;
    height: 100%;
  }

  .dg-quiz__product-info {
    text-align: center;
    margin-bottom: var(--dg-spacing-md);
  }

  .dg-quiz__product-name {
    font-size: var(--dg-font-size-base);
    font-weight: 600;
    margin: 0 0 var(--dg-spacing-xs);
  }

  .dg-quiz__product-benefits {
    font-size: var(--dg-font-size-sm);
    color: var(--dg-text-secondary);
    margin: 0 0 var(--dg-spacing-sm);
  }

  .dg-quiz__product-price {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--dg-spacing-sm);
  }

  .dg-quiz__price-original {
    font-size: var(--dg-font-size-sm);
    color: var(--dg-text-muted);
    text-decoration: line-through;
  }

  .dg-quiz__price-sale {
    font-size: var(--dg-font-size-lg);
    font-weight: 700;
    color: var(--dg-gold);
  }

  .dg-quiz__restart {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--dg-spacing-xs);
    width: 100%;
    background: none;
    border: none;
    color: var(--dg-text-muted);
    font-family: inherit;
    font-size: var(--dg-font-size-sm);
    cursor: pointer;
    padding: var(--dg-spacing-sm);
    transition: color var(--dg-transition-fast);
  }

  .dg-quiz__restart:hover {
    color: var(--dg-text-primary);
  }

  /* Responsive */
  @media (min-width: 640px) {
    .dg-quiz__input-group {
      flex-direction: row;
    }

    .dg-quiz__input-group .dg-quiz__btn {
      flex-shrink: 0;
    }

    .dg-quiz__product {
      display: grid;
      grid-template-columns: 120px 1fr;
      grid-template-rows: auto auto;
      gap: var(--dg-spacing-md);
      align-items: center;
    }

    .dg-quiz__product-image {
      margin: 0;
      grid-row: 1 / 3;
    }

    .dg-quiz__product-info {
      text-align: left;
      margin: 0;
    }

    .dg-quiz__product-price {
      justify-content: flex-start;
    }

    .dg-quiz__btn--cta {
      grid-column: 2;
    }
  }

  /* SVG Visualization Animations */
  .dg-viz__battery-fill {
    transition: width 0.8s ease-out;
  }

  .dg-viz__clock-arc {
    stroke-dasharray: 283;
    stroke-dashoffset: 283;
    animation: drawArc 1s ease-out forwards;
  }

  @keyframes drawArc {
    to { stroke-dashoffset: 0; }
  }

  .dg-viz__wave-path {
    stroke-dasharray: 500;
    stroke-dashoffset: 500;
    animation: drawWave 1.5s ease-out forwards;
  }

  @keyframes drawWave {
    to { stroke-dashoffset: 0; }
  }

  .dg-viz__droplet {
    animation: dropletMove 1.5s ease-in-out infinite;
  }

  .dg-viz__droplet--up {
    animation-name: dropletUp;
    animation-iteration-count: 1;
  }

  .dg-viz__droplet--down {
    animation-name: dropletDown;
    animation-iteration-count: 1;
  }

  @keyframes dropletUp {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-30px); opacity: 0; }
  }

  @keyframes dropletDown {
    0% { transform: translateY(-20px); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
  }

  .dg-viz__calendar-check {
    opacity: 0;
    transform: scale(0);
    animation: checkAppear 0.3s ease-out forwards;
  }

  @keyframes checkAppear {
    to { opacity: 1; transform: scale(1); }
  }

  /* Loading state */
  .dg-quiz__screen--loading {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .dg-quiz__loader {
    width: 40px;
    height: 40px;
    border: 3px solid var(--dg-bg-card);
    border-top-color: var(--dg-gold);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script>
  (function() {
    const sectionId = '{{ section.id }}';
    const quiz = document.getElementById(`dreamglow-quiz-${sectionId}`);

    if (!quiz) return;

    const state = {
      currentQuestion: 0,
      answers: [],
      scores: [],
      totalScore: 0,
      email: null,
      started: false
    };

    const config = {
      enableEmail: quiz.dataset.enableEmail === 'true',
      productUrl: quiz.dataset.productUrl,
      discountCode: quiz.dataset.discountCode,
      discountPercent: quiz.dataset.discountPercent,
      totalQuestions: 5
    };

    const deficiencies = {
      sleep_duration: { name: 'Uyku Suresi', ingredient: 'Melisa & Papatya', category: 'sleep' },
      bedtime: { name: 'Uyku Zamani', ingredient: 'Melisa & Papatya', category: 'sleep' },
      skin_feel: { name: 'Cilt Nemlendirme', ingredient: 'Hyaluronik Asit', category: 'skin' },
      stress_level: { name: 'Stres Yonetimi', ingredient: 'Papatya', category: 'recovery' },
      supplement_usage: { name: 'Takviye Rutini', ingredient: 'Kolajen + Hyaluronik Asit', category: 'recovery' }
    };

    const questionTypes = ['sleep_duration', 'bedtime', 'skin_feel', 'stress_level', 'supplement_usage'];

    // Initialize
    function init() {
      bindEvents();
    }

    // Event Binding
    function bindEvents() {
      // Start button
      const startBtn = quiz.querySelector('[data-action="start"]');
      if (startBtn) {
        startBtn.addEventListener('click', startQuiz);
      }

      // Answer buttons
      const answers = quiz.querySelectorAll('.dg-quiz__answer');
      answers.forEach(btn => {
        btn.addEventListener('click', handleAnswerClick);
      });

      // Next buttons
      const nextBtns = quiz.querySelectorAll('[data-action="next"]');
      nextBtns.forEach(btn => {
        btn.addEventListener('click', handleNextClick);
      });

      // Email form
      const emailForm = quiz.querySelector('[data-action="submit-email"]');
      if (emailForm) {
        emailForm.addEventListener('submit', handleEmailSubmit);
      }

      // Skip email
      const skipBtn = quiz.querySelector('[data-action="skip-email"]');
      if (skipBtn) {
        skipBtn.addEventListener('click', showResults);
      }

      // Restart
      const restartBtn = quiz.querySelector('[data-action="restart"]');
      if (restartBtn) {
        restartBtn.addEventListener('click', restartQuiz);
      }
    }

    // Start Quiz
    function startQuiz() {
      state.started = true;
      quiz.setAttribute('data-started', 'true');
      showScreen('question', 0);
      updateProgress(0);
    }

    // Handle Answer Click
    function handleAnswerClick(e) {
      const btn = e.currentTarget;
      const questionScreen = btn.closest('[data-question]');
      const questionIndex = parseInt(questionScreen.dataset.question);
      const answerIndex = parseInt(btn.dataset.answer);
      const score = parseInt(btn.dataset.score);
      const color = btn.dataset.color;
      const insight = btn.dataset.insight;

      // Mark as selected
      questionScreen.querySelectorAll('.dg-quiz__answer').forEach(a => a.classList.remove('selected'));
      btn.classList.add('selected');

      // Store answer
      state.answers[questionIndex] = answerIndex;
      state.scores[questionIndex] = score;

      // Show feedback
      showFeedback(questionIndex, answerIndex, score, color, insight);
    }

    // Show Feedback
    function showFeedback(questionIndex, answerIndex, score, color, insight) {
      const feedback = quiz.querySelector(`[data-feedback="${questionIndex}"]`);
      if (!feedback) return;

      // Update insight text
      const insightEl = feedback.querySelector('.dg-quiz__insight');
      if (insightEl) {
        insightEl.textContent = insight;
      }

      // Generate and inject visualization
      const vizContainer = feedback.querySelector('.dg-quiz__visualization');
      if (vizContainer) {
        const vizType = vizContainer.dataset.vizType;
        vizContainer.innerHTML = generateVisualization(vizType, score, color);
      }

      // Show feedback card
      feedback.classList.add('active');
    }

    // Generate Visualization SVG
    function generateVisualization(type, score, color) {
      const percentage = (score / 3) * 100;

      switch(type) {
        case 'sleep_duration':
          return generateBatteryViz(percentage, color);
        case 'bedtime':
          return generateClockViz(score, color);
        case 'skin_feel':
          return generateSkinViz(score, color);
        case 'stress_level':
          return generateWaveViz(score, color);
        case 'supplement_usage':
          return generateCalendarViz(score, color);
        default:
          return '';
      }
    }

    // Battery Visualization
    function generateBatteryViz(percentage, color) {
      const fillWidth = percentage * 1.2;
      return `
        <svg viewBox="0 0 160 80" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="10" y="15" width="130" height="50" rx="8" stroke="${color}" stroke-width="3" fill="none"/>
          <rect x="140" y="28" width="10" height="24" rx="2" fill="${color}" opacity="0.5"/>
          <rect class="dg-viz__battery-fill" x="16" y="21" width="${fillWidth}" height="38" rx="4" fill="${color}" style="width: 0; animation: batteryFill 0.8s ease-out forwards;"/>
          <style>
            @keyframes batteryFill { to { width: ${fillWidth}px; } }
          </style>
          <text x="75" y="48" text-anchor="middle" fill="${color}" font-size="18" font-weight="bold">${Math.round(percentage)}%</text>
        </svg>
      `;
    }

    // Clock Visualization
    function generateClockViz(score, color) {
      const goldColor = '#D4AF37';
      let userArcStart, userArcEnd, missesWindow;

      if (score === 3) { // 22:00-23:00
        userArcStart = 300; // 22:00
        userArcEnd = 330; // 23:00
        missesWindow = false;
      } else if (score === 2) { // 23:00-01:00
        userArcStart = 330; // 23:00
        userArcEnd = 30; // 01:00
        missesWindow = false;
      } else { // 01:00+
        userArcStart = 30;
        userArcEnd = 90;
        missesWindow = true;
      }

      return `
        <svg viewBox="0 0 160 160" fill="none" xmlns="http://www.w3.org/2000/svg">
          <!-- Clock face -->
          <circle cx="80" cy="80" r="70" stroke="#374151" stroke-width="2" fill="none"/>

          <!-- Hour markers -->
          ${[0,30,60,90,120,150,180,210,240,270,300,330].map(angle => `
            <line x1="${80 + 60 * Math.cos((angle - 90) * Math.PI / 180)}"
                  y1="${80 + 60 * Math.sin((angle - 90) * Math.PI / 180)}"
                  x2="${80 + 68 * Math.cos((angle - 90) * Math.PI / 180)}"
                  y2="${80 + 68 * Math.sin((angle - 90) * Math.PI / 180)}"
                  stroke="#6B7280" stroke-width="2"/>
          `).join('')}

          <!-- Golden Window (23:00 - 02:00) -->
          <path d="M 80 80 L ${80 + 55 * Math.cos((330 - 90) * Math.PI / 180)} ${80 + 55 * Math.sin((330 - 90) * Math.PI / 180)} A 55 55 0 0 1 ${80 + 55 * Math.cos((60 - 90) * Math.PI / 180)} ${80 + 55 * Math.sin((60 - 90) * Math.PI / 180)} Z"
                fill="${goldColor}" opacity="0.2"/>
          <path class="dg-viz__clock-arc" d="M ${80 + 55 * Math.cos((330 - 90) * Math.PI / 180)} ${80 + 55 * Math.sin((330 - 90) * Math.PI / 180)} A 55 55 0 0 1 ${80 + 55 * Math.cos((60 - 90) * Math.PI / 180)} ${80 + 55 * Math.sin((60 - 90) * Math.PI / 180)}"
                stroke="${goldColor}" stroke-width="4" fill="none" stroke-linecap="round"/>

          <!-- User indicator -->
          <circle cx="${80 + 45 * Math.cos((userArcStart - 90) * Math.PI / 180)}"
                  cy="${80 + 45 * Math.sin((userArcStart - 90) * Math.PI / 180)}"
                  r="8" fill="${color}"/>

          <!-- Labels -->
          <text x="80" y="24" text-anchor="middle" fill="#9CA3AF" font-size="10">24</text>
          <text x="80" y="145" text-anchor="middle" fill="#9CA3AF" font-size="10">12</text>
          <text x="145" y="84" text-anchor="middle" fill="#9CA3AF" font-size="10">06</text>
          <text x="15" y="84" text-anchor="middle" fill="#9CA3AF" font-size="10">18</text>

          <!-- Legend -->
          <rect x="45" y="150" width="12" height="4" rx="2" fill="${goldColor}" opacity="0.5"/>
          <text x="60" y="155" fill="#9CA3AF" font-size="8">Altin Pencere</text>
        </svg>
      `;
    }

    // Skin Visualization
    function generateSkinViz(score, color) {
      const dropletClass = score === 1 ? 'dg-viz__droplet--up' : 'dg-viz__droplet--down';
      const cellSize = score === 3 ? 14 : score === 2 ? 11 : 8;

      return `
        <svg viewBox="0 0 180 120" fill="none" xmlns="http://www.w3.org/2000/svg">
          <!-- Skin layers -->
          <path d="M0 30 Q45 25, 90 30 Q135 35, 180 30 L180 120 L0 120 Z" fill="#4A3728" opacity="0.3"/>
          <path d="M0 45 Q45 40, 90 45 Q135 50, 180 45 L180 120 L0 120 Z" fill="#5D4A3A" opacity="0.3"/>
          <path d="M0 60 Q45 55, 90 60 Q135 65, 180 60 L180 120 L0 120 Z" fill="#6B5747" opacity="0.3"/>

          <!-- Cells -->
          ${[30, 60, 90, 120, 150].map((x, i) => `
            <ellipse cx="${x}" cy="80" rx="${cellSize}" ry="${cellSize * 0.7}" fill="${color}" opacity="0.6">
              <animate attributeName="ry" values="${cellSize * 0.5};${cellSize * 0.7};${cellSize * 0.5}" dur="2s" repeatCount="indefinite" begin="${i * 0.2}s"/>
            </ellipse>
          `).join('')}

          <!-- Water droplets -->
          ${score === 1 ? `
            <g class="dg-viz__droplet ${dropletClass}" style="animation-delay: 0s">
              <path d="M45 50 Q48 42, 45 35 Q42 42, 45 50" fill="#60A5FA"/>
            </g>
            <g class="dg-viz__droplet ${dropletClass}" style="animation-delay: 0.3s">
              <path d="M90 45 Q93 37, 90 30 Q87 37, 90 45" fill="#60A5FA"/>
            </g>
            <g class="dg-viz__droplet ${dropletClass}" style="animation-delay: 0.6s">
              <path d="M135 50 Q138 42, 135 35 Q132 42, 135 50" fill="#60A5FA"/>
            </g>
          ` : `
            <g class="dg-viz__droplet ${dropletClass}" style="animation-delay: 0s">
              <path d="M45 70 Q48 62, 45 55 Q42 62, 45 70" fill="#60A5FA"/>
            </g>
            <g class="dg-viz__droplet ${dropletClass}" style="animation-delay: 0.3s">
              <path d="M90 65 Q93 57, 90 50 Q87 57, 90 65" fill="#60A5FA"/>
            </g>
            <g class="dg-viz__droplet ${dropletClass}" style="animation-delay: 0.6s">
              <path d="M135 70 Q138 62, 135 55 Q132 62, 135 70" fill="#60A5FA"/>
            </g>
          `}

          <!-- Label -->
          <text x="90" y="110" text-anchor="middle" fill="${color}" font-size="11" font-weight="500">
            ${score === 3 ? 'Nem Korunuyor' : score === 2 ? 'Kismen Nem Kaybi' : 'Nem Kaybi'}
          </text>
        </svg>
      `;
    }

    // Wave (Cortisol) Visualization
    function generateWaveViz(score, color) {
      const amplitude = score === 1 ? 30 : score === 2 ? 18 : 8;
      const frequency = score === 1 ? 3 : score === 2 ? 2 : 1.5;

      let pathD = 'M 10 60';
      for (let x = 10; x <= 170; x += 2) {
        const y = 60 + amplitude * Math.sin((x - 10) / 160 * frequency * Math.PI * 2);
        pathD += ` L ${x} ${y}`;
      }

      return `
        <svg viewBox="0 0 180 120" fill="none" xmlns="http://www.w3.org/2000/svg">
          <!-- Grid lines -->
          <line x1="10" y1="30" x2="170" y2="30" stroke="#374151" stroke-width="1" stroke-dasharray="4"/>
          <line x1="10" y1="60" x2="170" y2="60" stroke="#374151" stroke-width="1" stroke-dasharray="4"/>
          <line x1="10" y1="90" x2="170" y2="90" stroke="#374151" stroke-width="1" stroke-dasharray="4"/>

          <!-- Optimal zone -->
          <rect x="10" y="50" width="160" height="20" fill="#D4AF37" opacity="0.1"/>

          <!-- Wave -->
          <path class="dg-viz__wave-path" d="${pathD}" stroke="${color}" stroke-width="3" fill="none" stroke-linecap="round"/>

          <!-- Labels -->
          <text x="5" y="34" fill="#6B7280" font-size="8">Yuksek</text>
          <text x="5" y="94" fill="#6B7280" font-size="8">Dusuk</text>
          <text x="90" y="110" text-anchor="middle" fill="${color}" font-size="11" font-weight="500">
            Kortizol: ${score === 1 ? 'Yuksek' : score === 2 ? 'Orta' : 'Optimal'}
          </text>
        </svg>
      `;
    }

    // Calendar Visualization
    function generateCalendarViz(score, color) {
      const checkedDays = score === 3 ? 28 : score === 2 ? 14 : 0;
      const cells = [];

      for (let i = 0; i < 28; i++) {
        const row = Math.floor(i / 7);
        const col = i % 7;
        const x = 25 + col * 20;
        const y = 20 + row * 20;
        const isChecked = i < checkedDays;
        const delay = i * 0.05;

        cells.push(`
          <rect x="${x}" y="${y}" width="16" height="16" rx="3" fill="${isChecked ? color : '#374151'}" opacity="${isChecked ? 0.3 : 0.5}"/>
          ${isChecked ? `
            <path class="dg-viz__calendar-check" d="M${x + 4} ${y + 8} L${x + 7} ${y + 11} L${x + 12} ${y + 5}"
                  stroke="${color}" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"
                  style="animation-delay: ${delay}s"/>
          ` : ''}
        `);
      }

      return `
        <svg viewBox="0 0 180 120" fill="none" xmlns="http://www.w3.org/2000/svg">
          <!-- Calendar grid -->
          ${cells.join('')}

          <!-- Label -->
          <text x="90" y="110" text-anchor="middle" fill="${color}" font-size="11" font-weight="500">
            ${score === 3 ? 'Duzenli Kullanim' : score === 2 ? 'Duzensiz' : 'Kullanim Yok'}
          </text>
        </svg>
      `;
    }

    // Handle Next Click
    function handleNextClick(e) {
      const btn = e.currentTarget;
      const feedback = btn.closest('.dg-quiz__feedback');

      // Hide current feedback
      if (feedback) {
        feedback.classList.remove('active');
      }

      // Move to next question or show email/results
      state.currentQuestion++;

      if (state.currentQuestion >= config.totalQuestions) {
        // Calculate total score
        state.totalScore = state.scores.reduce((a, b) => a + b, 0);

        if (config.enableEmail) {
          showScreen('email');
        } else {
          showResults();
        }
      } else {
        showScreen('question', state.currentQuestion);
        updateProgress(state.currentQuestion);
      }
    }

    // Handle Email Submit
    function handleEmailSubmit(e) {
      e.preventDefault();
      const input = e.target.querySelector('input[type="email"]');
      if (input && input.value) {
        state.email = input.value;
        saveToLocalStorage();
      }
      showResults();
    }

    // Show Results
    function showResults() {
      showScreen('results');
      updateProgress(config.totalQuestions);

      // Calculate scores for each category
      const sleepScore = ((state.scores[0] || 0) + (state.scores[1] || 0)) / 2;
      const skinScore = state.scores[2] || 0;
      const recoveryScore = ((state.scores[3] || 0) + (state.scores[4] || 0)) / 2;

      // Find lowest score / primary deficiency
      let lowestIndex = 0;
      let lowestScore = 4;
      state.scores.forEach((score, index) => {
        if (score < lowestScore) {
          lowestScore = score;
          lowestIndex = index;
        }
      });

      const deficiency = deficiencies[questionTypes[lowestIndex]];

      // Update UI with animation delays
      setTimeout(() => {
        // Overall score
        const maxScore = config.totalQuestions * 3;
        const percentage = (state.totalScore / maxScore) * 100;
        const scoreCircle = quiz.querySelector('.dg-quiz__score-fill');
        const scoreValue = quiz.querySelector('.dg-quiz__score-value');

        if (scoreCircle) {
          const circumference = 283;
          const targetOffset = circumference - (percentage / 100) * circumference;
          // Animate with requestAnimationFrame for Shopify compatibility
          animateCircle(scoreCircle, circumference, targetOffset);
        }

        if (scoreValue) {
          animateValue(scoreValue, 0, Math.round(percentage), 1000);
        }

        // Deficiency
        const deficiencyValue = quiz.querySelector('.dg-quiz__deficiency-value');
        if (deficiencyValue) {
          deficiencyValue.textContent = deficiency.name;
        }

        // Score breakdown bars - using setAttribute for Shopify compatibility
        const sleepBar = quiz.querySelector('[data-category="sleep"] .dg-quiz__score-item-fill');
        const skinBar = quiz.querySelector('[data-category="skin"] .dg-quiz__score-item-fill');
        const recoveryBar = quiz.querySelector('[data-category="recovery"] .dg-quiz__score-item-fill');

        // Animate bars with requestAnimationFrame for Shopify compatibility
        animateBar(sleepBar, (sleepScore / 3) * 100);
        animateBar(skinBar, (skinScore / 3) * 100, 200);
        animateBar(recoveryBar, (recoveryScore / 3) * 100, 400);

        // Recommendation text
        const recText = quiz.querySelector('.dg-quiz__recommendation-text');
        if (recText) {
          recText.textContent = `Analizine gore en kritik eksik: ${deficiency.name}. DreamGlow icindeki ${deficiency.ingredient} bu sorunu cozmek icin ozel olarak formule edilmistir.`;
        }
      }, 300);

      saveToLocalStorage();
    }

    // Animate number value
    function animateValue(el, start, end, duration) {
      let startTime = null;

      function animation(currentTime) {
        if (!startTime) startTime = currentTime;
        const progress = Math.min((currentTime - startTime) / duration, 1);
        const value = Math.floor(progress * (end - start) + start);
        el.textContent = value;

        if (progress < 1) {
          requestAnimationFrame(animation);
        }
      }

      requestAnimationFrame(animation);
    }

    // Animate progress bar with scaleX transform - Shopify compatible
    function animateBar(el, targetPercent, delay = 0) {
      if (!el) return;

      // Force initial state with scaleX
      el.style.cssText = 'width:100%!important;height:8px!important;background:linear-gradient(90deg,#D4AF37,#F5DEB3)!important;border-radius:4px!important;position:absolute!important;top:0!important;left:0!important;transform:scaleX(0)!important;transform-origin:left center!important;';

      setTimeout(() => {
        let startTime = null;
        const duration = 1000;
        const targetScale = targetPercent / 100;

        function animation(currentTime) {
          if (!startTime) startTime = currentTime;
          const progress = Math.min((currentTime - startTime) / duration, 1);
          // Ease out cubic
          const eased = 1 - Math.pow(1 - progress, 3);
          const currentScale = eased * targetScale;

          el.style.transform = `scaleX(${currentScale})`;

          if (progress < 1) {
            requestAnimationFrame(animation);
          }
        }

        requestAnimationFrame(animation);
      }, delay);
    }

    // Animate SVG circle stroke - Shopify compatible
    function animateCircle(el, circumference, targetOffset) {
      if (!el) return;

      let startTime = null;
      const duration = 1000;
      const startOffset = circumference;

      function animation(currentTime) {
        if (!startTime) startTime = currentTime;
        const progress = Math.min((currentTime - startTime) / duration, 1);
        // Ease out cubic
        const eased = 1 - Math.pow(1 - progress, 3);
        const currentOffset = startOffset - (eased * (startOffset - targetOffset));

        el.style.strokeDashoffset = currentOffset;
        el.setAttribute('stroke-dashoffset', currentOffset);

        if (progress < 1) {
          requestAnimationFrame(animation);
        }
      }

      requestAnimationFrame(animation);
    }

    // Show Screen
    function showScreen(type, index = null) {
      // Hide all screens
      quiz.querySelectorAll('.dg-quiz__screen').forEach(screen => {
        screen.classList.remove('active');
      });

      // Show target screen
      let targetScreen;
      if (type === 'question' && index !== null) {
        targetScreen = quiz.querySelector(`[data-screen="question"][data-question="${index}"]`);
      } else {
        targetScreen = quiz.querySelector(`[data-screen="${type}"]`);
      }

      if (targetScreen) {
        targetScreen.classList.add('active');
      }
    }

    // Update Progress
    function updateProgress(current) {
      const progress = (current / config.totalQuestions) * 100;
      const progressBar = quiz.querySelector('.dg-quiz__progress-bar');
      const progressText = quiz.querySelector('.dg-quiz__progress-text');

      if (progressBar) {
        progressBar.style.width = `${progress}%`;
      }

      if (progressText) {
        progressText.textContent = `${current} / ${config.totalQuestions}`;
      }
    }

    // Save to LocalStorage
    function saveToLocalStorage() {
      const data = {
        answers: state.answers,
        scores: state.scores,
        totalScore: state.totalScore,
        email: state.email,
        timestamp: new Date().toISOString()
      };

      try {
        localStorage.setItem(`dreamglow_quiz_${sectionId}`, JSON.stringify(data));
      } catch (e) {
        console.warn('Could not save quiz data to localStorage');
      }
    }

    // Restart Quiz
    function restartQuiz() {
      state.currentQuestion = 0;
      state.answers = [];
      state.scores = [];
      state.totalScore = 0;
      state.email = null;
      state.started = false;

      quiz.setAttribute('data-started', 'false');

      // Reset all selected answers
      quiz.querySelectorAll('.dg-quiz__answer').forEach(btn => {
        btn.classList.remove('selected');
      });

      // Reset progress
      updateProgress(0);

      // Show intro
      showScreen('intro');
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

{% schema %}
{
  "name": "DreamGlow Quiz",
  "tag": "section",
  "class": "dreamglow-quiz-section",
  "settings": [
    {
      "type": "header",
      "content": "Genel Ayarlar"
    },
    {
      "type": "text",
      "id": "quiz_title",
      "label": "Quiz Basligi",
      "default": "Uyku & Cilt Analizi"
    },
    {
      "type": "text",
      "id": "quiz_subtitle",
      "label": "Alt Baslik",
      "default": "3 dakikada kisisel raporunu al"
    },
    {
      "type": "text",
      "id": "start_button",
      "label": "Baslat Butonu Metni",
      "default": "Teste Basla"
    },
    {
      "type": "checkbox",
      "id": "enable_email",
      "label": "Email Toplama Aktif",
      "default": true,
      "info": "Sonuclardan once email formu goster"
    },
    {
      "type": "header",
      "content": "Email Ekrani"
    },
    {
      "type": "text",
      "id": "email_title",
      "label": "Email Ekrani Basligi",
      "default": "Kisisel Raporun Hazir!"
    },
    {
      "type": "text",
      "id": "email_subtitle",
      "label": "Email Ekrani Alt Basligi",
      "default": "Tam analiz ve oneriler icin email adresini gir"
    },
    {
      "type": "header",
      "content": "Urun Ayarlari"
    },
    {
      "type": "product",
      "id": "recommended_product",
      "label": "Onerilen Urun"
    },
    {
      "type": "text",
      "id": "discount_code",
      "label": "Indirim Kodu",
      "default": "GECE15",
      "info": "URL'ye eklenecek indirim kodu"
    },
    {
      "type": "text",
      "id": "discount_percent",
      "label": "Indirim Yuzdesi",
      "default": "15",
      "info": "CTA butonunda gosterilecek yuzde"
    },
    {
      "type": "header",
      "content": "Renkler"
    },
    {
      "type": "color",
      "id": "color_gold",
      "label": "Altin/Pozitif Renk",
      "default": "#D4AF37"
    },
    {
      "type": "color",
      "id": "color_amber",
      "label": "Amber/Orta Renk",
      "default": "#F59E0B"
    },
    {
      "type": "color",
      "id": "color_red",
      "label": "Kirmizi/Negatif Renk",
      "default": "#EF4444"
    }
  ],
  "presets": [
    {
      "name": "DreamGlow Quiz",
      "category": "Interactive"
    }
  ]
}
{% endschema %}
